<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEON SERPENT ‚àû ULTIMATE</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--ng:#39ff14;--np:#ff2e63;--nb:#00d4ff;--ny:#ffe600;--nv:#b026ff;--no:#ff6b2b;--nc:#00ffb3;--bg:#020208;--nw:#ffffff}
body{background:var(--bg);color:#fff;font-family:'Rajdhani',sans-serif;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}

/* === AMBIENT === */
.layer-noise{position:fixed;inset:0;z-index:998;pointer-events:none;opacity:.035;
background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");background-size:128px 128px}
.layer-scan{position:fixed;inset:0;z-index:999;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 1px,rgba(0,0,0,.04) 1px,rgba(0,0,0,.04) 2px)}
.layer-vig{position:fixed;inset:0;z-index:997;pointer-events:none;background:radial-gradient(ellipse at 50% 50%,transparent 35%,rgba(0,0,0,.55) 100%)}
.bg-canvas{position:fixed;inset:0;z-index:0}.bg-canvas canvas{width:100%;height:100%}
.orb{position:fixed;border-radius:50%;z-index:0;animation:orbF 20s ease-in-out infinite}
.orb:nth-child(2){width:600px;height:600px;background:radial-gradient(circle,rgba(57,255,20,.12),transparent 70%);top:-200px;left:-200px}
.orb:nth-child(3){width:500px;height:500px;background:radial-gradient(circle,rgba(255,46,99,.08),transparent 70%);bottom:-150px;right:-150px;animation-delay:-7s}
.orb:nth-child(4){width:400px;height:400px;background:radial-gradient(circle,rgba(0,212,255,.07),transparent 70%);top:30%;left:60%;animation-delay:-13s}
.orb:nth-child(5){width:300px;height:300px;background:radial-gradient(circle,rgba(176,38,255,.06),transparent 70%);bottom:30%;left:10%;animation-delay:-4s}
@keyframes orbF{0%,100%{transform:translate(0,0) scale(1)}20%{transform:translate(50px,-40px) scale(1.1)}40%{transform:translate(-30px,30px) scale(.92)}60%{transform:translate(40px,20px) scale(1.05)}80%{transform:translate(-50px,-20px) scale(.95)}}

/* === WRAPPER === */
.gw{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;gap:12px;max-width:600px;width:100%;padding:0 16px}

/* === TITLE === */
.title-wrap{text-align:center;padding:4px 0}
.title-main{font-family:'Orbitron',sans-serif;font-size:1.8rem;font-weight:900;letter-spacing:.25em;
background:linear-gradient(90deg,var(--ng),var(--nb),var(--nv),var(--np),var(--ny),var(--ng));
background-size:400% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;color:transparent;
animation:tShift 5s linear infinite;position:relative}
.title-main::after{content:'NEON SERPENT';position:absolute;left:0;top:0;
background:linear-gradient(90deg,var(--ng),var(--nb),var(--nv),var(--np),var(--ny),var(--ng));
background-size:400% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;color:transparent;
animation:tShift 5s linear infinite;filter:blur(12px);opacity:.5;z-index:-1}
@keyframes tShift{0%{background-position:0% 50%}100%{background-position:400% 50%}}
.title-sub{font-size:.55rem;letter-spacing:.6em;color:rgba(255,255,255,.15);margin-top:2px;font-weight:300}

/* === HUD === */
.hud{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;width:100%;max-width:560px}
.hud-card{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04);border-radius:10px;padding:8px 6px;text-align:center;position:relative;overflow:hidden;backdrop-filter:blur(20px);transition:border-color .3s}
.hud-card::before{content:'';position:absolute;top:0;left:20%;right:20%;height:1px}
.hud-card.sc::before{background:var(--ng)}.hud-card.cc::before{background:var(--ny)}.hud-card.lc::before{background:var(--nb)}.hud-card.hic::before{background:var(--np)}
.hud-card::after{content:'';position:absolute;inset:0;opacity:0;transition:opacity .2s;border-radius:10px}
.hud-card.sc::after{background:radial-gradient(ellipse at 50% 0%,rgba(57,255,20,.06),transparent 70%)}
.hud-card.cc::after{background:radial-gradient(ellipse at 50% 0%,rgba(255,230,0,.06),transparent 70%)}
.hud-card.lc::after{background:radial-gradient(ellipse at 50% 0%,rgba(0,212,255,.06),transparent 70%)}
.hud-card.hic::after{background:radial-gradient(ellipse at 50% 0%,rgba(255,46,99,.06),transparent 70%)}
.hud-card.glow::after{opacity:1}
.hud-lbl{font-family:'Orbitron',sans-serif;font-size:.42rem;letter-spacing:.2em;text-transform:uppercase;color:rgba(255,255,255,.2);position:relative;z-index:1}
.hud-val{font-family:'Orbitron',sans-serif;font-size:1.25rem;font-weight:900;position:relative;z-index:1;transition:transform .12s cubic-bezier(.68,-.55,.27,1.55)}
.hud-val.sc2{color:var(--ng);text-shadow:0 0 15px rgba(57,255,20,.4)}
.hud-val.co2{color:var(--ny);text-shadow:0 0 15px rgba(255,230,0,.4)}
.hud-val.lv2{color:var(--nb);text-shadow:0 0 15px rgba(0,212,255,.4)}
.hud-val.hi2{color:var(--np);text-shadow:0 0 15px rgba(255,46,99,.4)}
.hud-val.bump{transform:scale(1.35)}

/* === CANVAS === */
.c-frame{position:relative;border-radius:14px;padding:2px;width:100%;max-width:564px;aspect-ratio:1;
background:conic-gradient(from 0deg,rgba(57,255,20,.4),rgba(0,212,255,.3),rgba(176,38,255,.3),rgba(255,46,99,.3),rgba(255,230,0,.3),rgba(57,255,20,.4));
animation:frameRot 8s linear infinite;
box-shadow:0 0 50px rgba(57,255,20,.06),0 0 100px rgba(57,255,20,.03),0 30px 80px rgba(0,0,0,.6)}
@keyframes frameRot{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}
.c-inner{border-radius:12px;overflow:hidden;position:relative;width:100%;height:100%;background:rgba(2,2,8,.98)}
canvas#game{display:block;width:100%;height:100%;border-radius:12px}
.sflash{position:absolute;inset:0;border-radius:12px;pointer-events:none;opacity:0;z-index:5;transition:opacity .06s ease;mix-blend-mode:screen}

/* === POWERUPS BAR === */
.pw-bar{display:flex;gap:5px;align-items:center;font-family:'Orbitron',sans-serif;font-size:.5rem;letter-spacing:.08em;flex-wrap:wrap;justify-content:center}
.pw-pill{display:flex;align-items:center;gap:4px;padding:4px 8px;border-radius:16px;border:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.015);opacity:.25;transition:all .5s cubic-bezier(.175,.885,.32,1.275);position:relative;overflow:hidden}
.pw-pill.on{opacity:1;transform:scale(1.08)}
.pw-pill.on.sp{border-color:rgba(0,212,255,.4);background:rgba(0,212,255,.08);color:var(--nb);box-shadow:0 0 20px rgba(0,212,255,.15)}
.pw-pill.on.gh{border-color:rgba(176,38,255,.4);background:rgba(176,38,255,.08);color:var(--nv);box-shadow:0 0 20px rgba(176,38,255,.15)}
.pw-pill.on.db{border-color:rgba(255,230,0,.4);background:rgba(255,230,0,.08);color:var(--ny);box-shadow:0 0 20px rgba(255,230,0,.15)}
.pw-pill.on.mg{border-color:rgba(255,107,43,.4);background:rgba(255,107,43,.08);color:var(--no);box-shadow:0 0 20px rgba(255,107,43,.15)}
.pw-pill.on.sh{border-color:rgba(0,255,179,.4);background:rgba(0,255,179,.08);color:var(--nc);box-shadow:0 0 20px rgba(0,255,179,.15)}
.pw-pill.on.fz{border-color:rgba(150,200,255,.4);background:rgba(150,200,255,.08);color:#96c8ff;box-shadow:0 0 20px rgba(150,200,255,.15)}
.pw-pill .tmr{position:absolute;bottom:0;left:0;height:2px;background:currentColor;border-radius:0 0 16px 16px;transition:width .15s linear}
.pw-i{font-size:.7rem}.pw-pill .pw-label{color:rgba(255,255,255,.35)}.pw-pill.on .pw-label{color:currentColor}

/* === OVERLAYS === */
.ov{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
background:rgba(2,2,8,.94);backdrop-filter:blur(16px) saturate(1.2);z-index:50;border-radius:12px;
transition:opacity .5s cubic-bezier(.4,0,.2,1),transform .5s cubic-bezier(.4,0,.2,1)}
.ov.hidden{opacity:0;transform:scale(.92);pointer-events:none}
.ov-scroll{max-height:90%;overflow-y:auto;width:100%;display:flex;flex-direction:column;align-items:center;padding:16px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent}

/* Start / Menu */
.s-art{font-size:4rem;margin-bottom:8px;animation:sArt 3s ease-in-out infinite;filter:drop-shadow(0 0 30px rgba(57,255,20,.5))}
@keyframes sArt{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-6px) scale(1.02)}}
.s-title{font-family:'Orbitron',sans-serif;font-size:2.2rem;font-weight:900;letter-spacing:.15em;
background:linear-gradient(135deg,var(--ng),var(--nb),var(--nv));-webkit-background-clip:text;-webkit-text-fill-color:transparent;
filter:drop-shadow(0 0 20px rgba(57,255,20,.3));margin-bottom:4px}
.s-ver{font-size:.5rem;color:rgba(255,255,255,.12);letter-spacing:.5em;margin-bottom:16px;font-family:'Orbitron',sans-serif}

.mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;max-width:320px;margin-bottom:16px}
.mode-card{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .3s}
.mode-card:hover{transform:translateY(-2px);box-shadow:0 0 30px rgba(57,255,20,.12)}
.mode-card:hover.mc-classic{border-color:var(--ng)}.mode-card:hover.mc-maze{border-color:var(--nb)}
.mode-card:hover.mc-time{border-color:var(--ny)}.mode-card:hover.mc-endless{border-color:var(--nv)}
.mc-icon{font-size:1.6rem;margin-bottom:4px}.mc-name{font-family:'Orbitron',sans-serif;font-size:.65rem;font-weight:700;letter-spacing:.1em}
.mc-desc{font-size:.45rem;color:rgba(255,255,255,.3);margin-top:3px;line-height:1.3}
.mc-best{font-family:'Orbitron',sans-serif;font-size:.4rem;color:rgba(255,255,255,.15);margin-top:5px}
.menu-btns{display:flex;gap:8px;margin-top:6px}
.menu-btn{font-family:'Orbitron',sans-serif;font-size:.45rem;letter-spacing:.15em;padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);color:rgba(255,255,255,.4);cursor:pointer;transition:all .3s}
.menu-btn:hover{border-color:rgba(255,255,255,.2);color:rgba(255,255,255,.7);background:rgba(255,255,255,.05)}

/* Settings */
.set-title{font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:900;letter-spacing:.15em;color:var(--nb);margin-bottom:16px}
.set-row{display:flex;align-items:center;justify-content:space-between;width:260px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.03)}
.set-label{font-size:.55rem;color:rgba(255,255,255,.4);letter-spacing:.1em}
.set-toggle{width:40px;height:22px;border-radius:11px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);cursor:pointer;position:relative;transition:all .3s}
.set-toggle.on{background:rgba(57,255,20,.2);border-color:var(--ng)}.set-toggle.on::after{left:19px;background:var(--ng)}
.set-toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,.3);transition:all .3s}
.skin-row{display:flex;gap:6px;margin:10px 0}
.skin-opt{width:36px;height:36px;border-radius:8px;border:2px solid rgba(255,255,255,.06);cursor:pointer;transition:all .3s;position:relative}
.skin-opt.active{border-color:var(--ng);box-shadow:0 0 15px rgba(57,255,20,.3)}
.skin-opt:hover{border-color:rgba(255,255,255,.3)}
.vol-slider{-webkit-appearance:none;width:100px;height:4px;border-radius:2px;background:rgba(255,255,255,.1);outline:none}
.vol-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--ng);cursor:pointer;box-shadow:0 0 10px rgba(57,255,20,.4)}

/* Achievements */
.ach-title{font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:900;letter-spacing:.15em;color:var(--ny);margin-bottom:12px}
.ach-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;width:100%;max-width:340px;margin-bottom:16px}
.ach-card{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04);border-radius:8px;padding:10px 6px;text-align:center;transition:all .3s}
.ach-card.unlocked{border-color:rgba(255,230,0,.2);background:rgba(255,230,0,.03)}
.ach-card.locked{opacity:.35;filter:grayscale(1)}
.ach-icon{font-size:1.2rem;margin-bottom:3px}.ach-name{font-family:'Orbitron',sans-serif;font-size:.38rem;font-weight:700;letter-spacing:.05em;color:rgba(255,255,255,.6)}
.ach-desc{font-size:.35rem;color:rgba(255,255,255,.2);margin-top:2px}
.ach-count{font-family:'Orbitron',sans-serif;font-size:.55rem;color:var(--ny);margin-bottom:12px}

/* Toast notification */
.toast{position:absolute;top:12px;right:12px;z-index:100;padding:10px 16px;border-radius:10px;
background:rgba(255,230,0,.1);border:1px solid rgba(255,230,0,.3);backdrop-filter:blur(10px);
display:flex;align-items:center;gap:8px;transform:translateX(120%);transition:transform .5s cubic-bezier(.175,.885,.32,1.275);pointer-events:none}
.toast.show{transform:translateX(0)}
.toast-icon{font-size:1.2rem}.toast-text{font-family:'Orbitron',sans-serif;font-size:.45rem;color:var(--ny);letter-spacing:.1em}

/* Buttons */
.btn{font-family:'Orbitron',sans-serif;font-weight:700;letter-spacing:.2em;text-transform:uppercase;border:none;border-radius:8px;cursor:pointer;position:relative;overflow:hidden;transition:all .3s cubic-bezier(.175,.885,.32,1.275)}
.btn-play{font-size:.75rem;padding:14px 36px;background:linear-gradient(135deg,var(--ng),#00cc44);color:#000;
box-shadow:0 0 40px rgba(57,255,20,.25),0 8px 32px rgba(0,0,0,.4)}
.btn-play:hover{transform:translateY(-3px) scale(1.04);box-shadow:0 0 60px rgba(57,255,20,.4)}
.btn-retry{font-size:.7rem;padding:12px 36px;background:linear-gradient(135deg,var(--np),#cc1144);color:#fff;
box-shadow:0 0 40px rgba(255,46,99,.25),0 8px 32px rgba(0,0,0,.4)}
.btn-retry:hover{transform:translateY(-3px) scale(1.04)}
.btn-sm{font-size:.55rem;padding:10px 24px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.5)}
.btn-sm:hover{background:rgba(255,255,255,.1);color:#fff}
.btn-back{font-size:.5rem;padding:8px 20px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);color:rgba(255,255,255,.3);margin-top:12px}
.btn-back:hover{color:rgba(255,255,255,.6);border-color:rgba(255,255,255,.15)}

/* Game Over */
.go-lbl{font-family:'Orbitron',sans-serif;font-size:.55rem;letter-spacing:.4em;color:rgba(255,255,255,.2);margin-bottom:6px}
.go-sc{font-family:'Orbitron',sans-serif;font-size:4rem;font-weight:900;line-height:1;margin-bottom:2px;
background:linear-gradient(135deg,var(--np),var(--nv),var(--nb));background-size:200% 200%;animation:goShift 3s ease infinite;
-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 40px rgba(255,46,99,.3))}
@keyframes goShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.go-nb{font-family:'Orbitron',sans-serif;font-size:.55rem;letter-spacing:.25em;color:var(--ny);text-shadow:0 0 15px rgba(255,230,0,.5);margin-bottom:12px;opacity:0;height:16px;transition:opacity .3s}
.go-nb.show{opacity:1;animation:nbPulse 1.5s ease infinite}
@keyframes nbPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.05)}}
.go-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px;width:300px}
.go-stat{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04);border-radius:8px;padding:8px 4px;text-align:center}
.go-stat .v{font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:900;color:var(--nb);text-shadow:0 0 10px rgba(0,212,255,.3)}
.go-stat .l{font-size:.35rem;color:rgba(255,255,255,.15);letter-spacing:.1em;text-transform:uppercase;font-family:'Orbitron',sans-serif;margin-top:2px}
.go-ach{margin-bottom:12px;text-align:center}
.go-ach-title{font-family:'Orbitron',sans-serif;font-size:.4rem;color:var(--ny);letter-spacing:.2em;margin-bottom:6px}
.go-ach-list{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
.go-ach-item{font-size:.9rem;padding:4px;background:rgba(255,230,0,.05);border-radius:6px;border:1px solid rgba(255,230,0,.15)}
.go-btns{display:flex;gap:8px}

/* Pause */
.p-ico{font-size:3rem;margin-bottom:8px;opacity:.4;animation:pP 2.5s ease-in-out infinite}
@keyframes pP{0%,100%{transform:scale(1);opacity:.4}50%{transform:scale(1.08);opacity:.6}}
.p-title{font-family:'Orbitron',sans-serif;font-size:1.2rem;font-weight:900;letter-spacing:.15em;color:var(--nb);margin-bottom:12px;text-shadow:0 0 20px rgba(0,212,255,.3)}
.p-btns{display:flex;gap:8px}

/* Controls */
.ctrl{font-size:.48rem;color:rgba(255,255,255,.1);letter-spacing:.25em;text-transform:uppercase;font-family:'Orbitron',sans-serif}
.ctrl kbd{display:inline-block;padding:1px 5px;border:1px solid rgba(255,255,255,.07);border-radius:3px;background:rgba(255,255,255,.02);margin:0 1px}

/* Mobile */
.mob{display:none;margin-top:10px}
.dpad{display:grid;grid-template-columns:repeat(3,50px);grid-template-rows:repeat(3,50px);gap:4px}
.dbtn{background:rgba(57,255,20,.04);border:1px solid rgba(57,255,20,.1);border-radius:12px;color:rgba(57,255,20,.6);font-size:1.2rem;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;-webkit-user-select:none;touch-action:manipulation;transition:all .08s}
.dbtn:active{background:rgba(57,255,20,.15);color:var(--ng);box-shadow:0 0 20px rgba(57,255,20,.2);transform:scale(.9)}.dbtn.x{visibility:hidden}

.shake{animation:shk .35s ease}
@keyframes shk{0%,100%{transform:translate(0)}10%{transform:translate(-6px,4px) rotate(-.5deg)}30%{transform:translate(-5px,-3px)}50%{transform:translate(-3px,2px)}70%{transform:translate(3px,-2px)}100%{transform:translate(0)}}
.chrom .c-inner{animation:chrm .6s ease-out}
@keyframes chrm{0%{filter:none}15%{filter:drop-shadow(-4px 0 rgba(255,0,0,.6)) drop-shadow(4px 0 rgba(0,255,255,.6)) blur(2px) brightness(1.5)}100%{filter:none}}

@media(max-width:600px){.title-main{font-size:1.1rem}.title-sub{display:none}.hud-val{font-size:1rem}.mob{display:block}.ctrl{display:none}
.s-title{font-size:1.4rem}.go-sc{font-size:2.5rem}.go-stats{grid-template-columns:repeat(2,1fr);width:200px}.mode-cards{max-width:260px}.ach-grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="layer-noise"></div><div class="layer-scan"></div><div class="layer-vig"></div>
<div class="bg-canvas"><canvas id="bgC"></canvas></div>
<div class="orb"></div><div class="orb"></div><div class="orb"></div><div class="orb"></div>

<div class="gw">
  <div class="title-wrap"><div class="title-main">NEON SERPENT</div><div class="title-sub">‚àû ULTIMATE EDITION v4.0 ‚àû</div></div>
  <div class="hud">
    <div class="hud-card sc" id="hcS"><div class="hud-lbl">Score</div><div class="hud-val sc2" id="dScore">0</div></div>
    <div class="hud-card cc" id="hcC"><div class="hud-lbl">Combo</div><div class="hud-val co2" id="dCombo">x1</div></div>
    <div class="hud-card lc" id="hcL"><div class="hud-lbl" id="dLvlLbl">Level</div><div class="hud-val lv2" id="dLevel">1</div></div>
    <div class="hud-card hic" id="hcH"><div class="hud-lbl">Best</div><div class="hud-val hi2" id="dHigh">0</div></div>
  </div>
  <div class="c-frame" id="cFrame">
    <div class="c-inner" id="cInner">
      <canvas id="game" width="560" height="560"></canvas>
      <div class="sflash" id="sFlash"></div>

      <!-- MAIN MENU -->
      <div class="ov" id="ovMenu">
        <div class="s-art">üêç</div><div class="s-title">NEON SERPENT</div><div class="s-ver">ULTIMATE EDITION v4.0</div>
        <div class="mode-cards">
          <div class="mode-card mc-classic" data-mode="classic"><div class="mc-icon">üéÆ</div><div class="mc-name">Classic</div><div class="mc-desc">Klasicky had. Zdi zabiji.</div><div class="mc-best" id="bestClassic">Best: 0</div></div>
          <div class="mode-card mc-maze" data-mode="maze"><div class="mc-icon">üèó</div><div class="mc-name">Maze</div><div class="mc-desc">Bludiste s prekazkami.</div><div class="mc-best" id="bestMaze">Best: 0</div></div>
          <div class="mode-card mc-time" data-mode="timeattack"><div class="mc-icon">‚è±</div><div class="mc-name">Time Attack</div><div class="mc-desc">90 sekund. Sbej co nejvic!</div><div class="mc-best" id="bestTime">Best: 0</div></div>
          <div class="mode-card mc-endless" data-mode="endless"><div class="mc-icon">‚àû</div><div class="mc-name">Endless</div><div class="mc-desc">Bez zdi. Stale rychleji.</div><div class="mc-best" id="bestEndless">Best: 0</div></div>
        </div>
        <div class="menu-btns">
          <button class="menu-btn" id="btnSettings">‚öô Settings</button>
          <button class="menu-btn" id="btnAch">üèÜ Achievements</button>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="ov hidden" id="ovSet">
        <div class="ov-scroll">
          <div class="set-title">SETTINGS</div>
          <div class="set-row"><span class="set-label">Sound FX</span><div class="set-toggle on" id="tgSound"></div></div>
          <div class="set-row"><span class="set-label">Music</span><div class="set-toggle" id="tgMusic"></div></div>
          <div class="set-row"><span class="set-label">Volume</span><input type="range" class="vol-slider" id="volSlider" min="0" max="100" value="50"></div>
          <div class="set-row"><span class="set-label">CRT Effect</span><div class="set-toggle" id="tgCRT"></div></div>
          <div class="set-row" style="flex-direction:column;align-items:flex-start;gap:6px"><span class="set-label">Snake Skin</span>
            <div class="skin-row" id="skinRow"></div>
          </div>
          <button class="btn btn-back" id="btnSetBack">‚Üê Back</button>
        </div>
      </div>

      <!-- ACHIEVEMENTS -->
      <div class="ov hidden" id="ovAch">
        <div class="ov-scroll">
          <div class="ach-title">ACHIEVEMENTS</div>
          <div class="ach-count" id="achCount">0 / 15</div>
          <div class="ach-grid" id="achGrid"></div>
          <button class="btn btn-back" id="btnAchBack">‚Üê Back</button>
        </div>
      </div>

      <!-- PAUSE -->
      <div class="ov hidden" id="ovPause">
        <div class="p-ico">‚è∏</div><div class="p-title">PAUZA</div>
        <div class="p-btns">
          <button class="btn btn-sm" id="btnResume">‚ñ∂ Resume</button>
          <button class="btn btn-sm" id="btnRestart">‚Üª Restart</button>
          <button class="btn btn-sm" id="btnQuit">‚úï Menu</button>
        </div>
      </div>

      <!-- GAME OVER -->
      <div class="ov hidden" id="ovGO">
        <div class="go-lbl">GAME OVER</div>
        <div class="go-sc" id="goSc">0</div>
        <div class="go-nb" id="goNb">‚òÖ NEW HIGH SCORE ‚òÖ</div>
        <div class="go-stats">
          <div class="go-stat"><div class="v" id="goEat">0</div><div class="l">Eaten</div></div>
          <div class="go-stat"><div class="v" id="goCombo">0</div><div class="l">Max Combo</div></div>
          <div class="go-stat"><div class="v" id="goLvl">0</div><div class="l">Level</div></div>
          <div class="go-stat"><div class="v" id="goTime">0s</div><div class="l">Time</div></div>
        </div>
        <div class="go-ach" id="goAchWrap" style="display:none"><div class="go-ach-title">ACHIEVEMENTS UNLOCKED</div><div class="go-ach-list" id="goAchList"></div></div>
        <div class="go-btns">
          <button class="btn btn-retry" id="btnRetry">‚Üª Znovu</button>
          <button class="btn btn-sm" id="btnGoMenu">Menu</button>
        </div>
      </div>

      <!-- TOAST -->
      <div class="toast" id="toast"><span class="toast-icon" id="toastIcon">üèÜ</span><span class="toast-text" id="toastText">Achievement!</span></div>
    </div>
  </div>

  <div class="pw-bar">
    <div class="pw-pill sp" id="pwS"><span class="pw-i">‚ö°</span><span class="pw-label">SPEED</span><div class="tmr" id="pwST"></div></div>
    <div class="pw-pill gh" id="pwG"><span class="pw-i">üëª</span><span class="pw-label">GHOST</span><div class="tmr" id="pwGT"></div></div>
    <div class="pw-pill db" id="pwD"><span class="pw-i">√ó2</span><span class="pw-label">PTS</span><div class="tmr" id="pwDT"></div></div>
    <div class="pw-pill mg" id="pwM"><span class="pw-i">üß≤</span><span class="pw-label">MAGNET</span><div class="tmr" id="pwMT"></div></div>
    <div class="pw-pill sh" id="pwSh"><span class="pw-i">üõ°</span><span class="pw-label">SHIELD</span><div class="tmr" id="pwShT"></div></div>
    <div class="pw-pill fz" id="pwF"><span class="pw-i">‚ùÑ</span><span class="pw-label">FREEZE</span><div class="tmr" id="pwFT"></div></div>
  </div>
  <div class="ctrl"><kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> / <kbd>‚Üë‚Üì‚Üê‚Üí</kbd> pohyb &nbsp; <kbd>SPACE</kbd> pauza &nbsp; <kbd>M</kbd> hudba</div>
  <div class="mob"><div class="dpad"><div class="dbtn x"></div><div class="dbtn" data-d="u">‚ñ≤</div><div class="dbtn x"></div><div class="dbtn" data-d="l">‚óÄ</div><div class="dbtn x"></div><div class="dbtn" data-d="r">‚ñ∂</div><div class="dbtn x"></div><div class="dbtn" data-d="d">‚ñº</div><div class="dbtn x"></div></div></div>
</div>

<script>
// ===== STORAGE =====
const ST={
  pre:'nserpent_',
  save(k,v){try{localStorage.setItem(this.pre+k,JSON.stringify(v))}catch(e){}},
  load(k,d){try{const v=localStorage.getItem(this.pre+k);return v?JSON.parse(v):d}catch(e){return d}}
};

// ===== AUDIO ENGINE =====
class SFX{
  constructor(){this.ctx=null;this.master=null;this.on=true;this.musicOn=false;this.vol=.5;this.musicNodes=null}
  init(){if(this.ctx)return;this.ctx=new(window.AudioContext||window.webkitAudioContext)();this.master=this.ctx.createGain();this.master.gain.value=this.vol;this.master.connect(this.ctx.destination)}
  ensure(){if(!this.ctx)this.init();if(this.ctx.state==='suspended')this.ctx.resume()}
  setVol(v){this.vol=v;if(this.master)this.master.gain.value=v}
  tone(freq,dur,type='sine',vol=.3,detune=0){
    if(!this.on)return;this.ensure();const t=this.ctx.currentTime;
    const o=this.ctx.createOscillator(),g=this.ctx.createGain();
    o.type=type;o.frequency.value=freq;o.detune.value=detune;
    g.gain.setValueAtTime(vol,t);g.gain.exponentialRampToValueAtTime(.001,t+dur);
    o.connect(g);g.connect(this.master);o.start(t);o.stop(t+dur)
  }
  noise(dur,vol=.15){
    if(!this.on)return;this.ensure();const t=this.ctx.currentTime;
    const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*dur,this.ctx.sampleRate);
    const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1);
    const s=this.ctx.createBufferSource(),g=this.ctx.createGain(),f=this.ctx.createBiquadFilter();
    s.buffer=buf;f.type='lowpass';f.frequency.value=800;
    g.gain.setValueAtTime(vol,t);g.gain.exponentialRampToValueAtTime(.001,t+dur);
    s.connect(f);f.connect(g);g.connect(this.master);s.start(t);s.stop(t+dur)
  }
  eat(combo){const f=440+Math.min(combo,20)*30;this.tone(f,.08,'sine',.25);this.tone(f*1.5,.06,'sine',.12)}
  eatSpecial(){this.tone(880,.15,'sine',.2);setTimeout(()=>this.tone(1100,.12,'sine',.15),60);setTimeout(()=>this.tone(1320,.1,'sine',.12),120)}
  eatGold(){this.tone(660,.2,'triangle',.25);setTimeout(()=>this.tone(880,.18,'triangle',.2),80);setTimeout(()=>this.tone(1100,.15,'triangle',.18),160);setTimeout(()=>this.tone(1320,.2,'triangle',.15),240)}
  powerUp(){this.tone(523,.08,'square',.12);setTimeout(()=>this.tone(659,.08,'square',.1),70);setTimeout(()=>this.tone(784,.12,'square',.08),140)}
  death(){this.noise(.4,.2);this.tone(120,.5,'sawtooth',.2);this.tone(80,.6,'sawtooth',.15,50)}
  levelUp(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>this.tone(f,.15,'sine',.15),i*80))}
  comboMilestone(){this.tone(784,.12,'sine',.2);this.tone(988,.12,'sine',.15);setTimeout(()=>{this.tone(1175,.15,'sine',.18);this.tone(1568,.2,'sine',.12)},100)}
  portal(){this.ensure();if(!this.on)return;const t=this.ctx.currentTime;const o=this.ctx.createOscillator(),g=this.ctx.createGain();
    o.type='sine';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(1200,t+.15);
    g.gain.setValueAtTime(.12,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);
    o.connect(g);g.connect(this.master);o.start(t);o.stop(t+.2)}
  shieldHit(){this.tone(440,.1,'square',.2);this.noise(.15,.15);this.tone(880,.15,'sine',.1)}
  achievement(){this.tone(784,.1,'sine',.2);setTimeout(()=>{this.tone(988,.1,'sine',.18);this.tone(1175,.15,'sine',.15)},100);setTimeout(()=>this.tone(1568,.25,'sine',.12),200)}
  click(){this.tone(800,.03,'sine',.08)}
  startMusic(){
    if(!this.musicOn||this.musicNodes)return;this.ensure();
    const t=this.ctx.currentTime;
    // Bass drone
    const bass=this.ctx.createOscillator(),bg=this.ctx.createGain();
    bass.type='sine';bass.frequency.value=55;bg.gain.value=.04;
    bass.connect(bg);bg.connect(this.master);bass.start(t);
    // Pad
    const pad=this.ctx.createOscillator(),pg=this.ctx.createGain(),pf=this.ctx.createBiquadFilter();
    pad.type='sawtooth';pad.frequency.value=110;pf.type='lowpass';pf.frequency.value=200;pg.gain.value=.02;
    pad.connect(pf);pf.connect(pg);pg.connect(this.master);pad.start(t);
    // LFO for filter
    const lfo=this.ctx.createOscillator(),lg=this.ctx.createGain();
    lfo.type='sine';lfo.frequency.value=.1;lg.gain.value=150;
    lfo.connect(lg);lg.connect(pf.frequency);lfo.start(t);
    this.musicNodes={bass,bg,pad,pg,pf,lfo,lg}
  }
  stopMusic(){
    if(!this.musicNodes)return;
    ['bass','pad','lfo'].forEach(k=>{try{this.musicNodes[k].stop()}catch(e){}});
    this.musicNodes=null
  }
}
const sfx=new SFX();

// ===== ACHIEVEMENTS =====
const ACHS=[
  {id:'first_blood',name:'First Blood',desc:'Snƒõz prvn√≠ j√≠dlo',icon:'ü©∏'},
  {id:'hungry',name:'Hungry',desc:'Snƒõz 50 v jedn√© h≈ôe',icon:'üçΩ'},
  {id:'starving',name:'Starving',desc:'Snƒõz 100 v jedn√© h≈ôe',icon:'ü§§'},
  {id:'combo5',name:'Combo x5',desc:'Dos√°hni √ó5 combo',icon:'üî•'},
  {id:'combo_king',name:'Combo King',desc:'Dos√°hni √ó10 combo',icon:'üëë'},
  {id:'combo_god',name:'Combo God',desc:'Dos√°hni √ó20 combo',icon:'‚ö°'},
  {id:'speed_demon',name:'Speed Demon',desc:'Dos√°hni level 5',icon:'üí®'},
  {id:'veteran',name:'Veteran',desc:'Dos√°hni level 10',icon:'üéñ'},
  {id:'collector',name:'Collector',desc:'Sebere≈° v≈°ech 6 typ≈Ø powerup≈Ø',icon:'üíé'},
  {id:'portal_user',name:'Portal Master',desc:'Pou≈æij port√°l 5√ó',icon:'üåÄ'},
  {id:'centurion',name:'Centurion',desc:'Sk√≥re 1000+',icon:'üèõ'},
  {id:'legend',name:'Legend',desc:'Sk√≥re 5000+',icon:'‚≠ê'},
  {id:'survivor2',name:'Survivor',desc:'P≈ôe≈æij 2 minuty',icon:'üïê'},
  {id:'survivor5',name:'Endurance',desc:'P≈ôe≈æij 5 minut',icon:'üïî'},
  {id:'shield_hero',name:'Shield Hero',desc:'Shield tƒõ zachr√°n√≠',icon:'üõ°'}
];
let unlockedAch=ST.load('ach',{});
let sessionNewAch=[];

function checkAch(){
  const checks={
    first_blood:()=>G.eaten>=1,hungry:()=>G.eaten>=50,starving:()=>G.eaten>=100,
    combo5:()=>G.maxCombo>=5,combo_king:()=>G.maxCombo>=10,combo_god:()=>G.maxCombo>=20,
    speed_demon:()=>G.level>=5,veteran:()=>G.level>=10,
    collector:()=>G.pwCollected&&G.pwCollected.size>=6,
    portal_user:()=>G.portalUses>=5,
    centurion:()=>G.score>=1000,legend:()=>G.score>=5000,
    survivor2:()=>G.playTime>=120,survivor5:()=>G.playTime>=300,
    shield_hero:()=>G.shieldSaves>=1
  };
  ACHS.forEach(a=>{
    if(!unlockedAch[a.id]&&checks[a.id]&&checks[a.id]()){
      unlockedAch[a.id]=Date.now();sessionNewAch.push(a);
      ST.save('ach',unlockedAch);showToast(a);sfx.achievement()
    }
  })
}

function showToast(a){
  const t=document.getElementById('toast'),ti=document.getElementById('toastIcon'),tt=document.getElementById('toastText');
  ti.textContent=a.icon;tt.textContent=a.name;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000)
}

// ===== SKINS =====
const SKINS={
  neon:{name:'Neon',preview:['#39ff14','#00d4ff','#b026ff'],fn:(i,l,fc)=>({h:(130+i/l*80+fc*2.5)%360,s:100,ll:58-i/l*12})},
  fire:{name:'Fire',preview:['#ff2e2e','#ff6b2b','#ffe600'],fn:(i,l,fc)=>({h:i/l*40,s:100,ll:55-i/l*15})},
  ice:{name:'Ice',preview:['#00d4ff','#96c8ff','#ffffff'],fn:(i,l,fc)=>({h:195+i/l*25,s:80,ll:62-i/l*10})},
  galaxy:{name:'Galaxy',preview:['#b026ff','#ff2e63','#00d4ff'],fn:(i,l,fc)=>({h:(270+i/l*80+fc)%360,s:85,ll:50-i/l*15})},
  matrix:{name:'Matrix',preview:['#39ff14','#1a8a0a','#0d4d05'],fn:(i,l,fc)=>({h:120,s:100,ll:55-i/l*30})}
};
let curSkin=ST.load('skin','neon');

// ===== MAZE PATTERNS =====
function genWalls(lv,mode){
  if(mode==='endless'||mode==='timeattack')return[];
  const w=[];
  if(mode==='classic'){
    if(lv>=3){const cx=10,cy=10;for(let i=-1;i<=1;i++){w.push({x:cx+i,y:cy-3});w.push({x:cx+i,y:cy+3})}}
    if(lv>=5){for(let i=3;i<=6;i++){w.push({x:3,y:i});w.push({x:16,y:i});w.push({x:3,y:19-i});w.push({x:16,y:19-i})}}
    if(lv>=7){for(let i=7;i<=12;i++){w.push({x:i,y:5});w.push({x:i,y:14})}}
  }else if(mode==='maze'){
    // Base pattern every level
    if(lv>=1){for(let i=5;i<=14;i++){w.push({x:i,y:4});w.push({x:i,y:15})}}
    if(lv>=2){for(let i=6;i<=14;i++){w.push({x:4,y:i});w.push({x:15,y:i})}}
    if(lv>=3){for(let i=7;i<=12;i++)w.push({x:i,y:10})}
    if(lv>=4){for(let i=7;i<=12;i++){w.push({x:7,y:i});w.push({x:12,y:i})}}
    if(lv>=5){w.push({x:9,y:7},{x:10,y:7},{x:9,y:12},{x:10,y:12})}
    // Remove some walls to make gaps
    const gaps=lv>=4?3:lv>=2?2:1;
    for(let g=0;g<gaps&&w.length>3;g++){const ri=Math.floor(Math.random()*w.length);w.splice(ri,1)}
  }
  return w
}

// ===== POWERUP DEFS =====
const PW={
  speed:{c:'#00d4ff',s:'‚ö°',d:5e3},ghost:{c:'#b026ff',s:'üëª',d:6e3},
  double:{c:'#ffe600',s:'√ó2',d:8e3},magnet:{c:'#ff6b2b',s:'üß≤',d:7e3},
  shield:{c:'#00ffb3',s:'üõ°',d:10e3},freeze:{c:'#96c8ff',s:'‚ùÑ',d:6e3}
};

// ===== GAME STATE =====
const G={
  NC:20,NR:20,CS:28,
  state:'menu',mode:'classic',
  snake:[],dir:{x:1,y:0},nextDir:{x:1,y:0},
  food:null,specialFood:null,goldenApple:null,poison:null,
  walls:[],portals:[],fieldPW:[],activePW:{},
  score:0,combo:1,comboTimer:0,maxCombo:1,eaten:0,level:1,
  baseSpeed:120,gameSpeed:120,
  timeLeft:90,playTime:0,gameStartTime:0,
  frameCount:0,pts:[],trails:[],popups:[],
  pwCollected:new Set(),portalUses:0,shieldSaves:0,portalCooldown:0,
  highScores:ST.load('highscores',{classic:0,maze:0,timeattack:0,endless:0}),
  totalStats:ST.load('stats',{games:0,eaten:0,deaths:0,time:0})
};

// ===== HELPERS =====
const cv=document.getElementById('game'),c=cv.getContext('2d'),cFrame=document.getElementById('cFrame'),sFlash=document.getElementById('sFlash');
function rCv(){const mx=Math.min(innerWidth-32,560);cv.style.width=mx+'px';cv.style.height=mx+'px'}rCv();addEventListener('resize',rCv);

function h2r(h,s,l){h/=360;s/=100;l/=100;let r,g,b;if(!s){r=g=b=l}else{const f=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<.5)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};const q=l<.5?l*(1+s):l+s-l*s,p=2*l-q;r=f(p,q,h+1/3);g=f(p,q,h);b=f(p,q,h-1/3)}return[~~(r*255),~~(g*255),~~(b*255)]}
function rrect(ctx,x,y,w,h,r){ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath()}
function star(ctx,cx,cy,n,oR,iR){let a=-Math.PI/2;const s=Math.PI/n;ctx.moveTo(cx+Math.cos(a)*oR,cy+Math.sin(a)*oR);for(let i=0;i<n;i++){ctx.lineTo(cx+Math.cos(a)*oR,cy+Math.sin(a)*oR);a+=s;ctx.lineTo(cx+Math.cos(a)*iR,cy+Math.sin(a)*iR);a+=s}ctx.closePath()}

function em(x,y,cl,n=10,opts={}){for(let i=0;i<n;i++){const a=Math.PI*2*i/n+Math.random()*.5,sp=2+Math.random()*(opts.sp||4);G.pts.push({x:x*G.CS+G.CS/2,y:y*G.CS+G.CS/2,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,lf:1,dc:.012+Math.random()*.02,sz:(opts.ms||2)+Math.random()*(opts.mx||5),c:cl,t:opts.t||'c'})}}
function tl(x,y,cl){G.trails.push({x:x*G.CS+G.CS/2,y:y*G.CS+G.CS/2,sz:G.CS*.7,lf:1,dc:.035,c:cl})}
function fl(cl,d=120){sFlash.style.background=cl;sFlash.style.opacity='.3';setTimeout(()=>sFlash.style.opacity='0',d)}
function popup(x,y,t,cl){G.popups.push({x:x*G.CS+G.CS/2,y:y*G.CS,t,c:cl,lf:1,sc:.3})}
function bump(id){const e=document.getElementById(id);if(!e)return;e.classList.add('bump');setTimeout(()=>e.classList.remove('bump'),180);const card=e.closest('.hud-card');if(card){card.classList.add('glow');setTimeout(()=>card.classList.remove('glow'),400)}}

function isOccupied(x,y){
  return G.snake.some(s=>s.x===x&&s.y===y)||
    G.walls.some(w=>w.x===x&&w.y===y)||
    (G.food&&G.food.x===x&&G.food.y===y)||
    (G.specialFood&&G.specialFood.x===x&&G.specialFood.y===y)||
    (G.goldenApple&&G.goldenApple.x===x&&G.goldenApple.y===y)||
    (G.poison&&G.poison.x===x&&G.poison.y===y)||
    G.portals.some(p=>(p.x1===x&&p.y1===y)||(p.x2===x&&p.y2===y))||
    G.fieldPW.some(p=>p.x===x&&p.y===y)
}
function findEmpty(){let p,tries=0;do{p={x:Math.floor(Math.random()*G.NC),y:Math.floor(Math.random()*G.NR)};tries++}while(isOccupied(p.x,p.y)&&tries<200);return p}

// ===== INIT =====
function initGame(mode){
  G.mode=mode;G.state='playing';
  const m=Math.floor(G.NC/2);
  G.snake=[{x:m,y:Math.floor(G.NR/2)},{x:m-1,y:Math.floor(G.NR/2)},{x:m-2,y:Math.floor(G.NR/2)}];
  G.dir={x:1,y:0};G.nextDir={x:1,y:0};
  G.score=0;G.combo=1;G.comboTimer=0;G.maxCombo=1;G.eaten=0;G.level=1;
  G.baseSpeed=mode==='endless'?100:120;G.gameSpeed=G.baseSpeed;
  G.timeLeft=90;G.playTime=0;G.gameStartTime=Date.now();G.frameCount=0;
  G.activePW={};G.fieldPW=[];G.pts=[];G.trails=[];G.popups=[];
  G.pwCollected=new Set();G.portalUses=0;G.shieldSaves=0;G.portalCooldown=0;
  G.specialFood=null;G.goldenApple=null;G.poison=null;
  sessionNewAch=[];
  G.walls=genWalls(1,mode);
  G.portals=[];
  G.food=findEmpty();
  // HUD label
  document.getElementById('dLvlLbl').textContent=mode==='timeattack'?'Time':'Level';
  updateHUD();updatePWBar();
  hideAllOv();startLoops()
}

// ===== SPAWN =====
function spawnFood(){G.food=findEmpty()}
function spawnSpecial(){if(G.specialFood||Math.random()>.15)return;G.specialFood={...findEmpty(),st:Date.now(),lt:5e3}}
function spawnGolden(){if(G.goldenApple||Math.random()>.93)return;G.goldenApple={...findEmpty(),st:Date.now(),lt:6e3}}
function spawnPoison(){if(G.poison||G.level<2||Math.random()>.85)return;G.poison={...findEmpty(),st:Date.now(),lt:7e3}}
function spawnPW(){if(G.fieldPW.length>=2||Math.random()>.25)return;const ts=Object.keys(PW),t=ts[Math.floor(Math.random()*ts.length)];G.fieldPW.push({...findEmpty(),type:t,st:Date.now(),lt:1e4})}
function spawnPortal(){
  if(G.portals.length>=2||G.level<4||(G.mode==='timeattack')||Math.random()>.7)return;
  const cols=['#00ffb3','#ff6b2b'];const cl=cols[G.portals.length%2];
  const p1=findEmpty(),p2=findEmpty();
  G.portals.push({x1:p1.x,y1:p1.y,x2:p2.x,y2:p2.y,c:cl})
}

// ===== UPDATE =====
function update(){
  G.frameCount++;G.playTime=(Date.now()-G.gameStartTime)/1000;
  if(G.portalCooldown>0)G.portalCooldown--;

  // Time attack countdown
  if(G.mode==='timeattack'){
    G.timeLeft=Math.max(0,90-G.playTime);
    if(G.timeLeft<=0){gameOver();return}
  }

  G.dir={...G.nextDir};
  const h={x:G.snake[0].x+G.dir.x,y:G.snake[0].y+G.dir.y};

  // Wall collision
  const wrap=G.mode==='endless'||G.mode==='timeattack'||!!G.activePW.ghost;
  if(h.x<0||h.x>=G.NC||h.y<0||h.y>=G.NR){
    if(wrap){h.x=(h.x+G.NC)%G.NC;h.y=(h.y+G.NR)%G.NR}
    else{if(G.activePW.shield){useShield();return}gameOver();return}
  }

  // Self collision
  if(!G.activePW.ghost){
    if(G.snake.some(s=>s.x===h.x&&s.y===h.y)){
      if(G.activePW.shield){useShield();return}
      gameOver();return
    }
  }

  // Wall obstacle collision
  if(G.walls.some(w=>w.x===h.x&&w.y===h.y)){
    if(G.activePW.ghost){/* pass through */}
    else if(G.activePW.shield){useShield();return}
    else{gameOver();return}
  }

  // Trail
  tl(G.snake[0].x,G.snake[0].y,`hsla(${(G.frameCount*3)%360},100%,60%,.12)`);
  G.snake.unshift(h);

  let ate=false;

  // Regular food
  if(h.x===G.food.x&&h.y===G.food.y){
    ate=true;G.eaten++;
    const p=10*G.combo*(G.activePW.double?2:1);G.score+=p;
    popup(h.x,h.y,'+'+p,'#39ff14');em(h.x,h.y,'#39ff14',18,{sp:6,mx:7});em(h.x,h.y,'#fff',8,{sp:3,mx:2,t:'s'});
    fl('rgba(57,255,20,.35)');bump('dScore');sfx.eat(G.combo);
    G.comboTimer=3e3;G.combo++;if(G.combo>G.maxCombo)G.maxCombo=G.combo;bump('dCombo');
    // Combo milestones
    if(G.combo%5===0){sfx.comboMilestone();em(h.x,h.y,'#ffe600',25,{sp:8,mx:9});fl('rgba(255,230,0,.3)',200)}
    spawnFood();spawnPW();spawnSpecial();spawnGolden();spawnPoison();spawnPortal();
    // Level up
    if(G.eaten%8===0){
      G.level++;G.baseSpeed=G.mode==='endless'?Math.max(35,100-G.level*5):Math.max(45,120-(G.level-1)*8);
      if(!G.activePW.speed&&!G.activePW.freeze)G.gameSpeed=G.baseSpeed;
      bump('dLevel');fl('rgba(0,212,255,.4)',250);sfx.levelUp();
      // Update walls for maze/classic
      if(G.mode==='maze'||G.mode==='classic'){G.walls=genWalls(G.level,G.mode)}
    }
  }

  // Special food
  if(G.specialFood&&h.x===G.specialFood.x&&h.y===G.specialFood.y){
    ate=true;const p=25*G.combo*(G.activePW.double?2:1);G.score+=p;
    popup(h.x,h.y,'+'+p,'#b026ff');em(h.x,h.y,'#b026ff',22,{sp:7,mx:8});em(h.x,h.y,'#fff',10,{sp:4,mx:3,t:'s'});
    fl('rgba(176,38,255,.4)',200);bump('dScore');sfx.eatSpecial();G.specialFood=null
  }

  // Golden apple
  if(G.goldenApple&&h.x===G.goldenApple.x&&h.y===G.goldenApple.y){
    ate=true;const p=50*G.combo*(G.activePW.double?2:1);G.score+=p;
    popup(h.x,h.y,'+'+p,'#ffe600');em(h.x,h.y,'#ffe600',30,{sp:8,mx:10});em(h.x,h.y,'#fff',12,{sp:5,mx:3,t:'s'});
    fl('rgba(255,230,0,.5)',300);bump('dScore');sfx.eatGold();
    // Temp shield bonus
    G.activePW.shield=Date.now()+5000;G.pwCollected.add('shield');updatePWBar();
    G.goldenApple=null
  }

  // Poison
  if(G.poison&&h.x===G.poison.x&&h.y===G.poison.y){
    if(G.activePW.shield){useShield();G.poison=null}
    else{em(h.x,h.y,'#ff0000',20,{sp:8});fl('rgba(255,0,0,.5)',300);G.poison=null;gameOver();return}
  }

  if(!ate)G.snake.pop();

  // Powerup pickup
  for(let i=G.fieldPW.length-1;i>=0;i--){
    const p=G.fieldPW[i];
    if(h.x===p.x&&h.y===p.y){
      activatePW(p.type);em(p.x,p.y,PW[p.type].c,20,{sp:6});popup(p.x,p.y,PW[p.type].s,PW[p.type].c);
      fl(PW[p.type].c+'33');sfx.powerUp();G.pwCollected.add(p.type);G.fieldPW.splice(i,1)
    }
  }

  // Portal check
  if(G.portalCooldown<=0){
    for(const p of G.portals){
      if(h.x===p.x1&&h.y===p.y1){teleport(h,p.x2,p.y2);break}
      if(h.x===p.x2&&h.y===p.y2){teleport(h,p.x1,p.y1);break}
    }
  }

  // Magnet
  if(G.activePW.magnet){
    const d=Math.abs(G.food.x-h.x)+Math.abs(G.food.y-h.y);
    if(d<=4){
      if(G.food.x<h.x)G.food.x++;else if(G.food.x>h.x)G.food.x--;
      if(G.food.y<h.y)G.food.y++;else if(G.food.y>h.y)G.food.y--
    }
  }

  // Combo decay
  if(G.comboTimer>0){G.comboTimer-=G.gameSpeed;if(G.comboTimer<=0){G.combo=1;bump('dCombo')}}

  // Expire field powerups
  const now=Date.now();
  G.fieldPW=G.fieldPW.filter(p=>now-p.st<p.lt);
  if(G.specialFood&&now-G.specialFood.st>G.specialFood.lt)G.specialFood=null;
  if(G.goldenApple&&now-G.goldenApple.st>G.goldenApple.lt)G.goldenApple=null;
  if(G.poison&&now-G.poison.st>G.poison.lt)G.poison=null;

  // Expire active powerups
  Object.keys(G.activePW).forEach(k=>{
    if(now>G.activePW[k]){
      delete G.activePW[k];
      if(k==='speed'||k==='freeze')G.gameSpeed=G.baseSpeed
    }
  });

  checkAch();updateHUD();updatePWBar()
}

function teleport(head,tx,ty){
  head.x=tx;head.y=ty;G.snake[0]=head;G.portalCooldown=3;G.portalUses++;
  em(tx,ty,'#00ffb3',15,{sp:5});fl('rgba(0,255,179,.3)',150);sfx.portal()
}
function useShield(){
  delete G.activePW.shield;G.shieldSaves++;
  em(G.snake[0].x,G.snake[0].y,'#00ffb3',25,{sp:8});fl('rgba(0,255,179,.5)',300);
  sfx.shieldHit();updatePWBar()
}
function activatePW(t){
  G.activePW[t]=Date.now()+PW[t].d;
  if(t==='speed')G.gameSpeed=G.baseSpeed*.6;
  if(t==='freeze')G.gameSpeed=G.baseSpeed*1.6;
  updatePWBar()
}

// ===== HUD =====
function updateHUD(){
  document.getElementById('dScore').textContent=G.score;
  document.getElementById('dCombo').textContent='x'+G.combo;
  const lv=G.mode==='timeattack'?Math.ceil(G.timeLeft)+'s':G.level;
  document.getElementById('dLevel').textContent=lv;
  const hs=G.highScores[G.mode]||0;
  document.getElementById('dHigh').textContent=hs
}
function updatePWBar(){
  const now=Date.now();
  [['speed','pwS','pwST','sp'],['ghost','pwG','pwGT','gh'],['double','pwD','pwDT','db'],['magnet','pwM','pwMT','mg'],['shield','pwSh','pwShT','sh'],['freeze','pwF','pwFT','fz']].forEach(([t,el,tm,cls])=>{
    const e=document.getElementById(el),ti=document.getElementById(tm),a=!!G.activePW[t];
    e.classList.toggle('on',a);
    if(a&&ti)ti.style.width=Math.max(0,(G.activePW[t]-now)/PW[t].d*100)+'%';
    else if(ti)ti.style.width='0%'
  })
}

// ===== RENDER =====
function draw(){
  c.clearRect(0,0,560,560);
  const t=Date.now()*.001;
  const CS=G.CS;

  // Grid dots
  for(let x=0;x<G.NC;x++)for(let y=0;y<G.NR;y++){
    c.fillStyle=`rgba(57,255,20,${.02+Math.sin(t+x*.3+y*.3)*.008})`;
    c.beginPath();c.arc(x*CS+CS/2,y*CS+CS/2,1,0,Math.PI*2);c.fill()
  }

  // Border danger glow (not in endless/timeattack)
  if(G.mode!=='endless'&&G.mode!=='timeattack'){
    const wA=.06+Math.sin(t*3)*.02;
    c.fillStyle=`rgba(255,46,99,${wA})`;c.fillRect(0,0,560,2);c.fillRect(0,558,560,2);c.fillRect(0,0,2,560);c.fillRect(558,0,2,560);
    const wg=25;
    [{g:c.createLinearGradient(0,0,0,wg),r:[0,0,560,wg]},{g:c.createLinearGradient(0,560,0,560-wg),r:[0,560-wg,560,wg]},{g:c.createLinearGradient(0,0,wg,0),r:[0,0,wg,560]},{g:c.createLinearGradient(560,0,560-wg,0),r:[560-wg,0,wg,560]}].forEach(w=>{
      w.g.addColorStop(0,`rgba(255,46,99,${wA})`);w.g.addColorStop(1,'transparent');c.fillStyle=w.g;c.fillRect(...w.r)
    })
  }

  // Walls
  G.walls.forEach(w=>{
    c.shadowColor='rgba(255,46,99,.6)';c.shadowBlur=12;
    c.fillStyle='rgba(255,46,99,.3)';c.beginPath();rrect(c,w.x*CS+2,w.y*CS+2,CS-4,CS-4,4);c.fill();
    c.shadowBlur=0;
    c.strokeStyle='rgba(255,46,99,.5)';c.lineWidth=1;c.beginPath();rrect(c,w.x*CS+2,w.y*CS+2,CS-4,CS-4,4);c.stroke()
  });

  // Portals
  G.portals.forEach(p=>{
    [p.x1,p.y1,p.x2,p.y2].forEach((v,i)=>{
      if(i%2===0){
        const px=([p.x1,p.x2])[i/2]*CS+CS/2,py=([p.y1,p.y2])[i/2]*CS+CS/2;
        // Aura
        const pg=c.createRadialGradient(px,py,0,px,py,CS*.7);
        pg.addColorStop(0,p.c+'33');pg.addColorStop(1,'transparent');
        c.fillStyle=pg;c.beginPath();c.arc(px,py,CS*.7,0,Math.PI*2);c.fill();
        // Ring
        c.strokeStyle=p.c+'99';c.lineWidth=2;c.setLineDash([4,4]);
        c.beginPath();c.arc(px,py,CS*.4,t*3,t*3+Math.PI*1.5);c.stroke();c.setLineDash([]);
        // Center
        c.shadowColor=p.c;c.shadowBlur=15;c.fillStyle=p.c;
        c.beginPath();c.arc(px,py,4+Math.sin(t*5)*2,0,Math.PI*2);c.fill();c.shadowBlur=0
      }
    })
  });

  // Trails
  G.trails.forEach(tr=>{c.globalAlpha=tr.lf*.5;c.fillStyle=tr.c;c.beginPath();c.arc(tr.x,tr.y,tr.sz*tr.lf/2,0,Math.PI*2);c.fill()});c.globalAlpha=1;

  // Snake
  const skin=SKINS[curSkin]||SKINS.neon;
  const sl=G.snake.length;
  for(let i=sl-1;i>=0;i--){
    const sg=G.snake[i],p=i/sl,isH=i===0;
    const col=skin.fn(i,sl,G.frameCount);
    let hu=col.h,sa=col.s||100,lu=col.ll||50;
    // Power-up overrides
    if(G.activePW.speed){hu=185+p*40;lu=55}
    else if(G.activePW.double){hu=45+p*25;lu=55}
    else if(G.activePW.ghost){hu=260+p*50;sa=75;lu=50}
    else if(G.activePW.freeze){hu=200+p*20;sa=60;lu=65}
    const[r,g,b]=h2r(hu,sa,lu);
    const al=G.activePW.ghost?.3+.4*(1-p):.97-p*.4;
    const sz=isH?CS-1:CS-1.5-p*4,of=(CS-sz)/2,rd=isH?8:Math.max(2,6-p*5);

    if(i<4){c.shadowColor=`rgba(${r},${g},${b},${.6-i*.13})`;c.shadowBlur=22-i*4}
    c.fillStyle=`rgba(${r},${g},${b},${al})`;c.beginPath();rrect(c,sg.x*CS+of,sg.y*CS+of,sz,sz,rd);c.fill();
    if(i<sl*.6){const sa2=.2*(1-p*1.7);if(sa2>0){c.fillStyle=`rgba(255,255,255,${sa2})`;c.beginPath();rrect(c,sg.x*CS+of+2,sg.y*CS+of+2,sz*.45,sz*.45,rd*.4);c.fill()}}
    if(p<.4){c.strokeStyle=`rgba(255,255,255,${.08*(1-p*2.5)})`;c.lineWidth=.5;c.beginPath();rrect(c,sg.x*CS+of,sg.y*CS+of,sz,sz,rd);c.stroke()}
    c.shadowBlur=0;

    // Head
    if(isH){
      const ex=sg.x*CS+CS/2,ey=sg.y*CS+CS/2,dr=G.dir;
      c.shadowColor='rgba(255,255,255,.4)';c.shadowBlur=6;c.fillStyle='rgba(255,255,255,.95)';
      [-1,1].forEach(s=>{c.beginPath();c.ellipse(ex+dr.x*5+dr.y*5*s,ey+dr.y*5+dr.x*5*s,4.5,3.5,0,0,Math.PI*2);c.fill()});
      c.shadowBlur=0;c.fillStyle='#111';
      [-1,1].forEach(s=>{c.beginPath();c.arc(ex+dr.x*7+dr.y*5*s,ey+dr.y*7+dr.x*5*s,2.2,0,Math.PI*2);c.fill()});
      c.fillStyle='rgba(255,255,255,.8)';
      [-1,1].forEach(s=>{c.beginPath();c.arc(ex+dr.x*6+dr.y*5*s-1,ey+dr.y*6+dr.x*5*s-1,1.1,0,Math.PI*2);c.fill()});
      if(Math.sin(t*12)>.3){c.strokeStyle='#ff4466';c.lineWidth=1.5;c.lineCap='round';
        const tx2=ex+dr.x*13,ty2=ey+dr.y*13;c.beginPath();c.moveTo(ex+dr.x*10,ey+dr.y*10);c.lineTo(tx2,ty2);c.stroke();
        c.beginPath();c.moveTo(tx2,ty2);c.lineTo(tx2+dr.y*3-dr.x*1,ty2-dr.x*3-dr.y*1);c.stroke();
        c.beginPath();c.moveTo(tx2,ty2);c.lineTo(tx2-dr.y*3-dr.x*1,ty2+dr.x*3-dr.y*1);c.stroke()}
      // Shield aura
      if(G.activePW.shield){
        c.strokeStyle=`rgba(0,255,179,${.3+Math.sin(t*6)*.15})`;c.lineWidth=2;c.setLineDash([3,3]);
        c.beginPath();c.arc(ex,ey,CS*.6,0,Math.PI*2);c.stroke();c.setLineDash([])
      }
    }
  }

  // Food
  const fx=G.food.x*CS+CS/2,fy=G.food.y*CS+CS/2,fp=1+Math.sin(t*5)*.18;
  const fa=c.createRadialGradient(fx,fy,0,fx,fy,CS);fa.addColorStop(0,'rgba(255,46,99,.12)');fa.addColorStop(.5,'rgba(255,46,99,.04)');fa.addColorStop(1,'transparent');c.fillStyle=fa;c.beginPath();c.arc(fx,fy,CS,0,Math.PI*2);c.fill();
  c.strokeStyle='rgba(255,46,99,.15)';c.lineWidth=1;c.setLineDash([3,5]);c.beginPath();c.ellipse(fx,fy,CS*.55,CS*.28,t*1.5,0,Math.PI*2);c.stroke();c.setLineDash([]);
  c.fillStyle='rgba(255,46,99,.6)';c.beginPath();c.arc(fx+Math.cos(t*4)*CS*.55,fy+Math.sin(t*4)*CS*.28,2.5,0,Math.PI*2);c.fill();
  c.shadowColor='rgba(255,46,99,.9)';c.shadowBlur=30;c.fillStyle='#ff2e63';c.beginPath();c.arc(fx,fy,CS*.3*fp,0,Math.PI*2);c.fill();
  c.shadowBlur=12;c.fillStyle='rgba(255,150,180,.5)';c.beginPath();c.arc(fx,fy,CS*.18*fp,0,Math.PI*2);c.fill();
  c.shadowBlur=0;c.fillStyle='rgba(255,255,255,.7)';c.beginPath();c.arc(fx-3,fy-3,CS*.08,0,Math.PI*2);c.fill();

  // Special food
  if(G.specialFood){const sf=G.specialFood,el=Date.now()-sf.st,rm=1-el/sf.lt,sp=1+Math.sin(t*8)*.22,sx=sf.x*CS+CS/2,sy=sf.y*CS+CS/2;
    c.globalAlpha=Math.min(1,rm*2.5);
    c.save();c.translate(sx,sy);c.rotate(t*1.5);const sg2=c.createRadialGradient(0,0,0,0,0,CS);sg2.addColorStop(0,'rgba(176,38,255,.15)');sg2.addColorStop(1,'transparent');c.fillStyle=sg2;c.fillRect(-CS,-CS,CS*2,CS*2);c.restore();
    c.shadowColor='rgba(176,38,255,1)';c.shadowBlur=35;c.fillStyle='#b026ff';c.save();c.translate(sx,sy);c.rotate(t*3);c.beginPath();star(c,0,0,6,CS*.4*sp,CS*.18*sp);c.fill();c.restore();
    c.shadowBlur=10;c.fillStyle='rgba(220,180,255,.4)';c.save();c.translate(sx,sy);c.rotate(-t*2);c.beginPath();star(c,0,0,6,CS*.22*sp,CS*.1*sp);c.fill();c.restore();c.shadowBlur=0;
    c.strokeStyle=`rgba(176,38,255,${rm*.8})`;c.lineWidth=2.5;c.lineCap='round';c.beginPath();c.arc(sx,sy,CS*.58,-Math.PI/2,-Math.PI/2+Math.PI*2*rm);c.stroke();c.globalAlpha=1}

  // Golden apple
  if(G.goldenApple){const ga=G.goldenApple,el=Date.now()-ga.st,rm=1-el/ga.lt,gp=1+Math.sin(t*6)*.2,gx=ga.x*CS+CS/2,gy=ga.y*CS+CS/2;
    c.globalAlpha=Math.min(1,rm*2.5);
    const gg=c.createRadialGradient(gx,gy,0,gx,gy,CS);gg.addColorStop(0,'rgba(255,230,0,.15)');gg.addColorStop(1,'transparent');c.fillStyle=gg;c.beginPath();c.arc(gx,gy,CS,0,Math.PI*2);c.fill();
    c.shadowColor='rgba(255,230,0,1)';c.shadowBlur=30;c.fillStyle='#ffe600';c.beginPath();c.arc(gx,gy,CS*.35*gp,0,Math.PI*2);c.fill();
    c.shadowBlur=10;c.fillStyle='rgba(255,255,200,.5)';c.beginPath();c.arc(gx,gy,CS*.18*gp,0,Math.PI*2);c.fill();c.shadowBlur=0;
    c.fillStyle='rgba(255,255,255,.8)';c.beginPath();c.arc(gx-3,gy-3,CS*.07,0,Math.PI*2);c.fill();
    // Sparkle particles
    for(let i=0;i<4;i++){const sa3=t*2+i*Math.PI/2,sr=CS*.5;c.fillStyle=`rgba(255,230,0,${.4+Math.sin(t*8+i)*.3})`;c.beginPath();c.arc(gx+Math.cos(sa3)*sr,gy+Math.sin(sa3)*sr,2,0,Math.PI*2);c.fill()}
    c.strokeStyle=`rgba(255,230,0,${rm*.6})`;c.lineWidth=2;c.beginPath();c.arc(gx,gy,CS*.55,-Math.PI/2,-Math.PI/2+Math.PI*2*rm);c.stroke();
    c.globalAlpha=1}

  // Poison
  if(G.poison){const po=G.poison,el=Date.now()-po.st,rm=1-el/po.lt,pp=1+Math.sin(t*7)*.15,px2=po.x*CS+CS/2,py2=po.y*CS+CS/2;
    c.globalAlpha=Math.min(1,rm*2.5);
    const pg2=c.createRadialGradient(px2,py2,0,px2,py2,CS);pg2.addColorStop(0,'rgba(255,0,0,.12)');pg2.addColorStop(1,'transparent');c.fillStyle=pg2;c.beginPath();c.arc(px2,py2,CS,0,Math.PI*2);c.fill();
    c.shadowColor='rgba(255,0,0,.8)';c.shadowBlur=20;c.fillStyle='#cc0000';c.beginPath();c.arc(px2,py2,CS*.3*pp,0,Math.PI*2);c.fill();
    c.shadowBlur=8;c.fillStyle='rgba(80,0,0,.6)';c.beginPath();c.arc(px2,py2,CS*.15*pp,0,Math.PI*2);c.fill();c.shadowBlur=0;
    // Skull-like X
    c.strokeStyle='rgba(255,255,255,.6)';c.lineWidth=2;c.lineCap='round';
    c.beginPath();c.moveTo(px2-4,py2-4);c.lineTo(px2+4,py2+4);c.stroke();
    c.beginPath();c.moveTo(px2+4,py2-4);c.lineTo(px2-4,py2+4);c.stroke();
    c.strokeStyle=`rgba(255,0,0,${rm*.5})`;c.lineWidth=1.5;c.beginPath();c.arc(px2,py2,CS*.5,-Math.PI/2,-Math.PI/2+Math.PI*2*rm);c.stroke();
    c.globalAlpha=1}

  // Field powerups
  G.fieldPW.forEach(pw=>{const inf=PW[pw.type],el=Date.now()-pw.st,rm=1-el/pw.lt,pl=1+Math.sin(t*7)*.15,ppx=pw.x*CS+CS/2,ppy=pw.y*CS+CS/2;
    c.globalAlpha=Math.min(1,rm*3);
    const hex=inf.c,rr2=parseInt(hex.slice(1,3),16),gg2=parseInt(hex.slice(3,5),16),bb2=parseInt(hex.slice(5,7),16);
    const pg3=c.createRadialGradient(ppx,ppy,0,ppx,ppy,CS*.8);pg3.addColorStop(0,`rgba(${rr2},${gg2},${bb2},.12)`);pg3.addColorStop(1,'transparent');c.fillStyle=pg3;c.beginPath();c.arc(ppx,ppy,CS*.8,0,Math.PI*2);c.fill();
    c.shadowColor=inf.c;c.shadowBlur=20;c.fillStyle=inf.c;c.save();c.translate(ppx,ppy);c.rotate(t*2.5);const ds=CS*.33*pl;c.beginPath();rrect(c,-ds/2,-ds/2,ds,ds,4);c.fill();c.restore();c.shadowBlur=0;
    c.fillStyle='rgba(255,255,255,.9)';c.font='bold 10px Orbitron';c.textAlign='center';c.textBaseline='middle';c.fillText(inf.s,ppx,ppy+1);
    c.strokeStyle=`rgba(${rr2},${gg2},${bb2},${rm*.5})`;c.lineWidth=1.5;c.lineCap='round';c.beginPath();c.arc(ppx,ppy,CS*.5,-Math.PI/2,-Math.PI/2+Math.PI*2*rm);c.stroke();c.globalAlpha=1});

  // Particles
  G.pts.forEach(p2=>{c.globalAlpha=p2.lf;if(p2.t==='s'){c.strokeStyle=p2.c;c.lineWidth=p2.sz*p2.lf*.6;c.lineCap='round';c.beginPath();c.moveTo(p2.x,p2.y);c.lineTo(p2.x-p2.vx*4,p2.y-p2.vy*4);c.stroke()}else{c.shadowColor=p2.c;c.shadowBlur=p2.sz*2;c.fillStyle=p2.c;c.beginPath();c.arc(p2.x,p2.y,p2.sz*p2.lf,0,Math.PI*2);c.fill();c.shadowBlur=0}});c.globalAlpha=1;

  // Score popups
  G.popups.forEach(p2=>{c.globalAlpha=p2.lf;const fs=16*p2.sc;c.font=`900 ${fs}px Orbitron`;c.textAlign='center';c.shadowColor=p2.c;c.shadowBlur=12;c.fillStyle=p2.c;c.fillText(p2.t,p2.x,p2.y);c.shadowBlur=0});c.globalAlpha=1;

  // Freeze overlay
  if(G.activePW.freeze){c.fillStyle='rgba(150,200,255,.04)';c.fillRect(0,0,560,560)}
}

// ===== VISUAL UPDATE (60fps) =====
function updateVisuals(){
  G.pts=G.pts.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=.94;p.vy*=.94;p.vy+=.04;p.lf-=p.dc;return p.lf>0});
  G.trails=G.trails.filter(t2=>{t2.lf-=t2.dc;return t2.lf>0});
  G.popups=G.popups.filter(p=>{p.lf-=.018;p.y-=1.5;p.sc=Math.min(1,p.sc+.1);return p.lf>0})
}

// ===== GAME FLOW =====
let logicTimer=null,rafId=null;

function startLoops(){
  stopLoops();
  logicTimer=setInterval(()=>{if(G.state==='playing')update()},G.gameSpeed);
  function frame(){updateVisuals();draw();rafId=requestAnimationFrame(frame)}
  rafId=requestAnimationFrame(frame);
  // Speed change watcher
  let lastSp=G.gameSpeed;
  G._speedCheck=setInterval(()=>{if(G.gameSpeed!==lastSp){lastSp=G.gameSpeed;clearInterval(logicTimer);logicTimer=setInterval(()=>{if(G.state==='playing')update()},G.gameSpeed)}},200)
}
function stopLoops(){
  clearInterval(logicTimer);logicTimer=null;
  if(rafId)cancelAnimationFrame(rafId);rafId=null;
  clearInterval(G._speedCheck)
}

function gameOver(){
  G.state='gameover';stopLoops();
  const nb=G.score>(G.highScores[G.mode]||0);
  if(nb)G.highScores[G.mode]=G.score;
  ST.save('highscores',G.highScores);
  // Update total stats
  G.totalStats.games++;G.totalStats.eaten+=G.eaten;G.totalStats.deaths++;G.totalStats.time+=G.playTime;
  ST.save('stats',G.totalStats);
  sfx.death();
  cFrame.classList.add('shake','chrom');setTimeout(()=>cFrame.classList.remove('shake','chrom'),600);
  fl('rgba(255,46,99,.5)',400);
  // Death particles
  G.snake.forEach((s,i)=>setTimeout(()=>{em(s.x,s.y,'#ff2e63',5,{sp:7});em(s.x,s.y,'#ff6b2b',3,{sp:4,t:'s'})},i*15));
  // Keep rendering for death anim
  let deathRaf;function deathFrame(){updateVisuals();draw();if(G.pts.length||G.trails.length)deathRaf=requestAnimationFrame(deathFrame)}
  deathRaf=requestAnimationFrame(deathFrame);
  // Show game over
  setTimeout(()=>{
    cancelAnimationFrame(deathRaf);
    document.getElementById('goSc').textContent=G.score;
    document.getElementById('goEat').textContent=G.eaten;
    document.getElementById('goCombo').textContent='x'+G.maxCombo;
    document.getElementById('goLvl').textContent=G.level;
    document.getElementById('goTime').textContent=Math.floor(G.playTime)+'s';
    document.getElementById('goNb').classList.toggle('show',nb);
    // Show new achievements
    const aw=document.getElementById('goAchWrap'),al=document.getElementById('goAchList');
    if(sessionNewAch.length){aw.style.display='block';al.innerHTML=sessionNewAch.map(a=>`<span class="go-ach-item" title="${a.name}">${a.icon}</span>`).join('')}
    else{aw.style.display='none'}
    showOv('ovGO')
  },800)
}

function togglePause(){
  if(G.state==='playing'){G.state='paused';clearInterval(logicTimer);showOv('ovPause')}
  else if(G.state==='paused'){G.state='playing';hideOv('ovPause');logicTimer=setInterval(()=>{if(G.state==='playing')update()},G.gameSpeed)}
}

function showMenu(){
  stopLoops();G.state='menu';
  // Update best scores
  document.getElementById('bestClassic').textContent='Best: '+G.highScores.classic;
  document.getElementById('bestMaze').textContent='Best: '+G.highScores.maze;
  document.getElementById('bestTime').textContent='Best: '+G.highScores.timeattack;
  document.getElementById('bestEndless').textContent='Best: '+G.highScores.endless;
  hideAllOv();showOv('ovMenu')
}

// ===== OVERLAY HELPERS =====
function showOv(id){document.getElementById(id).classList.remove('hidden')}
function hideOv(id){document.getElementById(id).classList.add('hidden')}
function hideAllOv(){['ovMenu','ovSet','ovAch','ovPause','ovGO'].forEach(hideOv)}

// ===== SETTINGS UI =====
function initSettings(){
  const soundOn=ST.load('soundOn',true);sfx.on=soundOn;
  const musicOn=ST.load('musicOn',false);sfx.musicOn=musicOn;
  const vol=ST.load('vol',50);sfx.setVol(vol/100);
  curSkin=ST.load('skin','neon');
  document.getElementById('tgSound').classList.toggle('on',soundOn);
  document.getElementById('tgMusic').classList.toggle('on',musicOn);
  document.getElementById('volSlider').value=vol;
  // Skin options
  const sr=document.getElementById('skinRow');sr.innerHTML='';
  Object.entries(SKINS).forEach(([k,v])=>{
    const d=document.createElement('div');d.className='skin-opt'+(k===curSkin?' active':'');
    d.title=v.name;d.style.background=`linear-gradient(135deg,${v.preview.join(',')})`;
    d.onclick=()=>{curSkin=k;ST.save('skin',k);sr.querySelectorAll('.skin-opt').forEach(s=>s.classList.remove('active'));d.classList.add('active');sfx.click()};
    sr.appendChild(d)
  })
}
document.getElementById('tgSound').onclick=function(){const on=!this.classList.contains('on');this.classList.toggle('on',on);sfx.on=on;ST.save('soundOn',on);sfx.click()};
document.getElementById('tgMusic').onclick=function(){const on=!this.classList.contains('on');this.classList.toggle('on',on);sfx.musicOn=on;ST.save('musicOn',on);if(on)sfx.startMusic();else sfx.stopMusic();sfx.click()};
document.getElementById('volSlider').oninput=function(){sfx.setVol(this.value/100);ST.save('vol',+this.value)};
document.getElementById('tgCRT').onclick=function(){const on=!this.classList.contains('on');this.classList.toggle('on',on);document.querySelector('.layer-scan').style.opacity=on?'1':'';ST.save('crt',on)};

// ===== ACHIEVEMENTS UI =====
function renderAchievements(){
  const grid=document.getElementById('achGrid');
  const count=Object.keys(unlockedAch).length;
  document.getElementById('achCount').textContent=count+' / '+ACHS.length;
  grid.innerHTML=ACHS.map(a=>{
    const ul=!!unlockedAch[a.id];
    return `<div class="ach-card ${ul?'unlocked':'locked'}"><div class="ach-icon">${ul?a.icon:'üîí'}</div><div class="ach-name">${a.name}</div><div class="ach-desc">${a.desc}</div></div>`
  }).join('')
}

// ===== BUTTON HANDLERS =====
document.querySelectorAll('.mode-card').forEach(card=>{
  card.onclick=()=>{sfx.ensure();sfx.click();initGame(card.dataset.mode);if(sfx.musicOn)sfx.startMusic()}
});
document.getElementById('btnSettings').onclick=()=>{sfx.click();hideOv('ovMenu');showOv('ovSet')};
document.getElementById('btnAch').onclick=()=>{sfx.click();renderAchievements();hideOv('ovMenu');showOv('ovAch')};
document.getElementById('btnSetBack').onclick=()=>{sfx.click();hideOv('ovSet');showOv('ovMenu')};
document.getElementById('btnAchBack').onclick=()=>{sfx.click();hideOv('ovAch');showOv('ovMenu')};
document.getElementById('btnResume').onclick=()=>{sfx.click();togglePause()};
document.getElementById('btnRestart').onclick=()=>{sfx.click();hideOv('ovPause');initGame(G.mode)};
document.getElementById('btnQuit').onclick=()=>{sfx.click();hideOv('ovPause');showMenu()};
document.getElementById('btnRetry').onclick=()=>{sfx.click();sfx.ensure();initGame(G.mode)};
document.getElementById('btnGoMenu').onclick=()=>{sfx.click();showMenu()};

// ===== INPUT =====
const dm={ArrowUp:{x:0,y:-1},w:{x:0,y:-1},W:{x:0,y:-1},ArrowDown:{x:0,y:1},s:{x:0,y:1},S:{x:0,y:1},ArrowLeft:{x:-1,y:0},a:{x:-1,y:0},A:{x:-1,y:0},ArrowRight:{x:1,y:0},d:{x:1,y:0},D:{x:1,y:0}};
document.addEventListener('keydown',e=>{
  if(e.key===' '){e.preventDefault();if(G.state==='playing'||G.state==='paused')togglePause();return}
  if(e.key==='m'||e.key==='M'){const tg=document.getElementById('tgMusic');tg.click();return}
  if(e.key==='Escape'){if(G.state==='playing')togglePause();return}
  const d=dm[e.key];if(d&&G.state==='playing'){if(d.x!==-G.dir.x||d.y!==-G.dir.y)G.nextDir=d;e.preventDefault()}
});
document.querySelectorAll('.dbtn[data-d]').forEach(b=>{const ds={u:{x:0,y:-1},d:{x:0,y:1},l:{x:-1,y:0},r:{x:1,y:0}};
  b.addEventListener('touchstart',e=>{e.preventDefault();const d=ds[b.dataset.d];if(d&&G.state==='playing'&&(d.x!==-G.dir.x||d.y!==-G.dir.y))G.nextDir=d})});
let tsx=0,tsy=0;
cv.addEventListener('touchstart',e=>{tsx=e.touches[0].clientX;tsy=e.touches[0].clientY});
cv.addEventListener('touchend',e=>{const dx=e.changedTouches[0].clientX-tsx,dy=e.changedTouches[0].clientY-tsy;if(Math.max(Math.abs(dx),Math.abs(dy))<20)return;let d;if(Math.abs(dx)>Math.abs(dy))d=dx>0?{x:1,y:0}:{x:-1,y:0};else d=dy>0?{x:0,y:1}:{x:0,y:-1};if(d.x!==-G.dir.x||d.y!==-G.dir.y)G.nextDir=d});

// ===== BACKGROUND =====
const bgCv=document.getElementById('bgC'),bgx=bgCv.getContext('2d');
function rBg(){bgCv.width=innerWidth;bgCv.height=innerHeight}rBg();addEventListener('resize',rBg);
let bgt=0;
function dBg(){
  bgx.clearRect(0,0,bgCv.width,bgCv.height);
  const w=bgCv.width,h=bgCv.height,cx=w/2,cy=h/2;
  bgx.lineWidth=1;
  for(let i=0;i<30;i++){
    const y=cy+(i*i*2.5)+((bgt*.2)%50),a=Math.max(0,.04-i*.001);
    bgx.strokeStyle=`rgba(57,255,20,${a})`;
    if(y<=h){bgx.beginPath();bgx.moveTo(0,y);bgx.lineTo(w,y);bgx.stroke()}
    const y2=cy-(i*i*2.5)-((bgt*.2)%50);
    if(y2>=0){bgx.beginPath();bgx.moveTo(0,y2);bgx.lineTo(w,y2);bgx.stroke()}
  }
  for(let i=-15;i<=15;i++){
    bgx.strokeStyle=`rgba(57,255,20,${.02-Math.abs(i)*.001})`;
    bgx.beginPath();bgx.moveTo(cx+i*70,h);bgx.lineTo(cx+i*1.5,cy);bgx.stroke()
  }
  const cg=bgx.createRadialGradient(cx,cy,0,cx,cy,200);
  cg.addColorStop(0,'rgba(57,255,20,0.015)');cg.addColorStop(1,'transparent');
  bgx.fillStyle=cg;bgx.fillRect(cx-200,cy-200,400,400);
  bgt++;requestAnimationFrame(dBg)
}dBg();

// ===== BOOT =====
function boot(){
  initSettings();
  // Load CRT
  const crt=ST.load('crt',false);
  document.getElementById('tgCRT').classList.toggle('on',crt);
  if(crt)document.querySelector('.layer-scan').style.opacity='1';
  showMenu();
  // Initial draw
  G.snake=[{x:10,y:10},{x:9,y:10},{x:8,y:10}];G.food={x:15,y:10};G.dir={x:1,y:0};
  draw()
}
boot();
</script>
</body>
</html>